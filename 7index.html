<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZOMBIE SURVIVOR: MULTIPLAYER ULTIMATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body { margin: 0; overflow: hidden; background: #020408; font-family: 'Inter', sans-serif; touch-action: none; }
        canvas { display: block; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; color: white; }
        .clickable { pointer-events: auto; }
        .font-game { font-family: 'Orbitron', sans-serif; }
        
        .modal-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(15px);
        }

        .avatar-card {
            border: 3px solid #1e293b;
            transition: all 0.2s;
            cursor: pointer;
            background: rgba(30, 41, 59, 0.3);
        }
        .avatar-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }

        #action-btn {
            width: 85px; height: 85px;
            background: radial-gradient(circle, #ef4444 0%, #7f1d1d 100%);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; border: 4px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .healing { background: #10b981; }
        .protected { background: #3b82f6; }
        .invisible-mod { background: #6366f1; }
        .soldier-mod { background: #fbbf24; color: black; }
        .moto-mod { background: #ec4899; }
        .flashlight-mod { background: #f59e0b; }
        
        .level-up-anim {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fbbf24; font-size: 4rem; font-weight: 900; z-index: 100;
            pointer-events: none; opacity: 0; text-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            transition: opacity 0.5s;
        }

        .config-slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: #1e293b;
            border-radius: 5px;
            outline: none;
        }
        .config-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .wall {
            position: absolute;
            background: #8B4513;
            border: 2px solid #654321;
            z-index: 5;
        }

        .maze-wall {
            background: #2c3e50;
            border: 2px solid #34495e;
        }

        .door {
            background: #d4a574;
            border: 3px solid #8B4513;
        }

        .construction-mode {
            border: 3px solid #10b981 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .torch-light {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            mix-blend-mode: screen;
        }

        .night-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 20, 0.7);
            z-index: 2;
            pointer-events: none;
            transition: background 2s ease;
        }
    </style>
</head>
<body>

    <div id="level-up-text" class="level-up-anim font-game">¬°NIVEL UP!</div>

    <!-- Pantalla de Inicio Principal -->
    <div id="main-menu" class="modal-screen flex clickable px-6 text-center">
        <h1 class="text-6xl font-black mb-6 text-blue-500 italic font-game tracking-tighter">SURVIVOR ULTIMATE</h1>
        <p class="text-gray-400 mb-10 text-sm">Modo Multijugador con Arma UZI - Laberintos y Construcci√≥n</p>
        
        <div class="w-full max-w-md flex flex-col gap-6">
            <button onclick="showSinglePlayerSetup()" class="bg-blue-600 text-white font-black py-5 rounded-2xl text-xl hover:bg-blue-700 font-game transition-all hover:scale-105">
                üéÆ SINGLE PLAYER
            </button>
            <button onclick="showMultiplayerSetup()" class="bg-green-600 text-white font-black py-5 rounded-2xl text-xl hover:bg-green-700 font-game transition-all hover:scale-105">
                üë• MULTIPLAYER
            </button>
            <button onclick="showConfiguration()" class="bg-purple-600 text-white font-black py-5 rounded-2xl text-xl hover:bg-purple-700 font-game transition-all hover:scale-105">
                ‚öôÔ∏è CONFIGURACI√ìN
            </button>
        </div>
    </div>

    <!-- Pantalla de Configuraci√≥n Single Player -->
    <div id="singleplayer-screen" class="modal-screen flex clickable px-6 text-center hidden">
        <h1 class="text-5xl font-black mb-6 text-blue-500 italic font-game tracking-tighter">SINGLE PLAYER</h1>
        
        <div id="setup-ui" class="flex flex-col items-center w-full max-w-md">
            <div class="grid grid-cols-4 gap-3 mb-8 w-full">
                <div onclick="selectAvatar(0)" id="av-0" class="avatar-card selected p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/3408/3408545.png" alt="Icono 1">
                </div>
                <div onclick="selectAvatar(1)" id="av-1" class="avatar-card p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" alt="Icono 2">
                </div>
                <div onclick="selectAvatar(2)" id="av-2" class="avatar-card p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/1154/1154443.png" alt="Icono 3">
                </div>
                <div onclick="selectAvatar(3)" id="av-3" class="avatar-card p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/606/606553.png" alt="Icono 4">
                </div>
            </div>

            <div class="w-full flex flex-col gap-4">
                <input id="player-name-input" type="text" maxlength="10" placeholder="NOMBRE DEL AGENTE" 
                    class="bg-slate-900 border-2 border-slate-700 text-white p-4 rounded-2xl text-center font-bold focus:border-blue-500 outline-none uppercase tracking-widest">
                
                <button id="start-btn" onclick="startGame(false, 'single')" class="bg-blue-600 text-white font-black py-4 rounded-2xl text-xl hover:bg-blue-700 font-game">
                    NUEVA MISI√ìN
                </button>
                <button id="resume-btn" onclick="startGame(true, 'single')" class="bg-green-600 text-white font-black py-4 rounded-2xl text-xl hover:bg-green-700 font-game">
                    REANUDAR PARTIDA GUARDADA
                </button>
                <button onclick="showMainMenu()" class="bg-gray-700 text-white font-black py-4 rounded-2xl text-xl hover:bg-gray-800 font-game">
                    VOLVER
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de Configuraci√≥n Multijugador -->
    <div id="multiplayer-screen" class="modal-screen flex clickable px-6 text-center hidden">
        <h1 class="text-5xl font-black mb-6 text-green-500 italic font-game tracking-tighter">MULTIPLAYER</h1>
        
        <div class="w-full max-w-md flex flex-col items-center gap-6">
            <div class="grid grid-cols-4 gap-3 mb-4 w-full">
                <div onclick="selectAvatar(0)" id="mp-av-0" class="avatar-card p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/3408/3408545.png" alt="Icono 1">
                </div>
                <div onclick="selectAvatar(1)" id="mp-av-1" class="avatar-card p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" alt="Icono 2">
                </div>
                <div onclick="selectAvatar(2)" id="mp-av-2" class="avatar-card selected p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/1154/1154443.png" alt="Icono 3">
                </div>
                <div onclick="selectAvatar(3)" id="mp-av-3" class="avatar-card p-2 rounded-2xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/606/606553.png" alt="Icono 4">
                </div>
            </div>

            <input id="mp-player-name-input" type="text" maxlength="10" placeholder="TU NOMBRE" 
                class="bg-slate-900 border-2 border-slate-700 text-white p-4 rounded-2xl text-center font-bold focus:border-green-500 outline-none uppercase tracking-widest w-full">

            <div class="w-full bg-black/40 p-4 rounded-2xl border border-white/10">
                <h3 class="text-green-400 font-bold text-xs uppercase mb-3 text-center tracking-widest">MODOS DISPONIBLES</h3>
                <div class="flex flex-col gap-2">
                    <button onclick="startMultiplayerGame('coop')" class="bg-green-700 text-white font-bold py-3 rounded-xl hover:bg-green-800">
                        üë• COOPERATIVO
                    </button>
                    <button onclick="startMultiplayerGame('pvp')" class="bg-red-700 text-white font-bold py-3 rounded-xl hover:bg-red-800">
                        ‚öîÔ∏è PVP (VS ZOMBIES)
                    </button>
                    <button onclick="startMultiplayerGame('survival')" class="bg-yellow-700 text-white font-bold py-3 rounded-xl hover:bg-yellow-800">
                        üõ°Ô∏è SUPERVIVENCIA
                    </button>
                </div>
            </div>

            <button onclick="showMainMenu()" class="bg-gray-700 text-white font-black py-4 rounded-2xl text-xl hover:bg-gray-800 font-game w-full">
                VOLVER
            </button>
        </div>
    </div>

    <!-- Pantalla de Configuraci√≥n -->
    <div id="configuration-screen" class="modal-screen flex clickable px-6 text-center hidden">
        <h1 class="text-5xl font-black mb-6 text-purple-500 italic font-game tracking-tighter">CONFIGURACI√ìN</h1>
        
        <div class="w-full max-w-md flex flex-col gap-6 bg-black/40 p-6 rounded-2xl border border-white/10">
            
            <div class="text-left">
                <label class="text-white font-bold block mb-2">üßü‚Äç‚ôÄÔ∏è VELOCIDAD ZOMBIES</label>
                <input type="range" min="50" max="200" value="100" class="config-slider" id="zombie-speed-slider">
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>Lento</span>
                    <span id="zombie-speed-value">Normal</span>
                    <span>R√°pido</span>
                </div>
            </div>

            <div class="text-left">
                <label class="text-white font-bold block mb-2">üë§ VELOCIDAD AVATAR</label>
                <input type="range" min="50" max="200" value="100" class="config-slider" id="avatar-speed-slider">
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>Lento</span>
                    <span id="avatar-speed-value">Normal</span>
                    <span>R√°pido</span>
                </div>
            </div>

            <div class="text-left">
                <label class="text-white font-bold block mb-2">üèçÔ∏è VELOCIDAD MOTO</label>
                <input type="range" min="50" max="200" value="100" class="config-slider" id="moto-speed-slider">
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>Lento</span>
                    <span id="moto-speed-value">Normal</span>
                    <span>R√°pido</span>
                </div>
            </div>

            <div class="text-left">
                <label class="text-white font-bold block mb-2">ü§ñ CANTIDAD DE BOTS</label>
                <input type="range" min="0" max="10" value="2" class="config-slider" id="bot-count-slider">
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>0</span>
                    <span id="bot-count-value">2 Bots</span>
                    <span>10</span>
                </div>
            </div>

            <div class="text-left">
                <label class="text-white font-bold block mb-2">üßü TAMA√ëO ZOMBIES</label>
                <input type="range" min="70" max="150" value="100" class="config-slider" id="zombie-size-slider">
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>Peque√±o</span>
                    <span id="zombie-size-value">Normal</span>
                    <span>Grande</span>
                </div>
            </div>

            <div class="text-left">
                <label class="text-white font-bold block mb-2">üéÆ DIFICULTAD</label>
                <select id="difficulty-select" class="w-full bg-slate-900 border-2 border-slate-700 text-white p-3 rounded-xl">
                    <option value="easy">F√°cil</option>
                    <option value="normal" selected>Normal</option>
                    <option value="hard">Dif√≠cil</option>
                    <option value="nightmare">Pesadilla</option>
                </select>
            </div>

            <div class="flex gap-4">
                <button onclick="saveConfiguration()" class="bg-green-600 text-white font-black py-4 flex-1 rounded-2xl hover:bg-green-700">
                    GUARDAR
                </button>
                <button onclick="showMainMenu()" class="bg-gray-700 text-white font-black py-4 flex-1 rounded-2xl hover:bg-gray-800">
                    VOLVER
                </button>
            </div>
        </div>
    </div>

    <!-- UI Principal -->
    <div class="ui-layer p-4 flex flex-col justify-between">
        <div class="flex justify-between items-start">
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-3">
                    <div id="lives-display" class="text-2xl drop-shadow-lg">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    <button id="pause-btn" onclick="togglePause()" class="clickable bg-white/10 p-2 rounded-xl text-xl backdrop-blur-md border border-white/20">‚è∏Ô∏è</button>
                    <button id="build-btn" onclick="toggleBuildMode()" class="clickable bg-green-600/20 p-2 rounded-xl text-xl backdrop-blur-md border border-green-500/30 hidden">üèóÔ∏è</button>
                    <button id="exit-btn" onclick="exitToMenu()" class="clickable bg-red-600/20 p-2 rounded-xl text-xl backdrop-blur-md border border-red-500/30 hidden">üö™</button>
                </div>
                <div id="hp-bar-cont" class="w-40 h-3 bg-gray-900/80 rounded-full border border-white/10 overflow-hidden mt-1">
                    <div id="hp-bar" class="h-full bg-red-500 transition-all"></div>
                </div>
                <div id="gas-bar-cont" class="w-32 h-2 bg-gray-900/80 rounded-full border border-white/10 overflow-hidden mt-1 hidden">
                    <div id="gas-bar" class="h-full bg-yellow-500"></div>
                </div>
                <div id="status-container" class="flex flex-col items-start gap-1"></div>
                <div id="time-indicator" class="text-xs text-yellow-400 mt-2 font-bold">
                    <span id="time-of-day">üåÖ D√≠a</span>
                </div>
            </div>

            <div class="flex flex-col items-end gap-2">
                <div class="bg-black/40 p-2 px-4 rounded-xl backdrop-blur-md border border-white/10 text-right">
                    <div class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Nivel</div>
                    <div id="level-display" class="text-2xl font-game font-black italic">01</div>
                </div>
                <div class="relative mt-2">
                    <button onclick="quickSwapWeapon()" class="clickable bg-slate-800 w-16 h-16 rounded-2xl border-2 border-slate-600 shadow-xl flex items-center justify-center text-3xl">
                        <span id="weapon-icon-btn">üî™</span>
                    </button>
                    <div id="ammo-count" class="absolute -bottom-2 -left-2 bg-amber-500 text-black text-[10px] font-bold px-2 rounded-full border border-white shadow-md">‚àû</div>
                </div>
                <button onclick="toggleFlashlight()" id="flashlight-btn" class="clickable bg-gray-800 w-12 h-12 rounded-xl border-2 border-yellow-600/50 hidden flex items-center justify-center text-xl">
                    üî¶
                </button>
            </div>
        </div>

        <div class="flex justify-between items-end p-2">
            <div class="flex flex-col gap-2">
                <div class="bg-black/60 p-3 rounded-2xl border border-white/10 flex flex-col gap-1">
                    <div class="flex justify-between gap-6 items-center">
                        <span class="text-[9px] text-green-400 font-bold uppercase tracking-widest">Objetivo Nivel</span>
                        <span id="z-remain" class="text-xs font-mono font-bold text-white">0/100</span>
                    </div>
                    <div class="w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                        <div id="objective-progress" class="h-full bg-green-500 transition-all" style="width: 0%"></div>
                    </div>
                    <div class="mt-1 flex justify-between items-center border-t border-white/5 pt-1">
                        <span class="text-[8px] text-gray-400 font-bold uppercase">Horda Detectada:</span>
                        <span id="map-zombies-count" class="text-[10px] font-mono text-red-400 font-bold">0</span>
                    </div>
                </div>
                <div id="construction-ui" class="hidden bg-black/60 p-3 rounded-2xl border border-green-500/30">
                    <div class="text-[10px] text-green-400 font-bold uppercase mb-2">MODO CONSTRUCCI√ìN</div>
                    <div class="flex gap-2">
                        <button onclick="placeWall()" class="clickable bg-slate-800 p-2 rounded-lg text-xs">üß± Muro</button>
                        <button onclick="placeDoor()" class="clickable bg-slate-800 p-2 rounded-lg text-xs">üö™ Puerta</button>
                        <button onclick="placeTorch()" class="clickable bg-slate-800 p-2 rounded-lg text-xs">üî• Antorcha</button>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div id="score-display" class="bg-black/40 p-2 px-4 rounded-xl text-right">
                    <div class="text-[8px] font-bold text-gray-500 uppercase tracking-widest">Score</div>
                    <div id="score-val" class="text-lg font-game font-black text-white">00000</div>
                </div>
                <div id="action-btn" class="clickable select-none">üí•</div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Fin de Juego -->
    <div id="game-over" class="modal-screen clickable">
        <h2 class="text-6xl font-black mb-4 text-red-600 font-game italic drop-shadow-2xl uppercase text-center">AGENTE CA√çDO</h2>
        <div id="final-stats" class="text-gray-400 mb-8 font-mono text-center text-lg leading-relaxed"></div>
        <div class="w-full max-w-sm bg-black/40 p-4 rounded-2xl border border-white/10 mb-6">
            <h3 class="text-blue-400 font-bold text-xs uppercase mb-3 text-center tracking-widest">Mejores Records</h3>
            <div id="leaderboard-list" class="flex flex-col gap-2"></div>
        </div>
        <button onclick="showMainMenu()" class="bg-white text-black font-black py-5 px-16 rounded-2xl text-xl font-game shadow-2xl">MEN√ö PRINCIPAL</button>
    </div>

    <!-- Capa de iluminaci√≥n y noche -->
    <div id="night-overlay" class="night-overlay"></div>
    
    <!-- Elementos de luz din√°micos -->
    <div id="light-container"></div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- CONFIGURACI√ìN DEL JUEGO ---
        const gameConfig = {
            zombieSpeed: 1.0,
            avatarSpeed: 1.0,
            motoSpeed: 1.0,
            botCount: 2,
            zombieSize: 1.0,
            difficulty: 'normal',
            gameMode: 'single'
        };

        // --- DEFINICI√ìN DE ARMAS (INCLUYENDO UZI) ---
        const WEAPONS = {
            KNIFE: { id: 'KNIFE', icon: 'üî™', range: 130, damage: 400, delay: 250, color: '#94a3b8' },
            PISTOL: { id: 'PISTOL', icon: 'üî´', speed: 28, damage: 150, delay: 200, color: '#fbbf24', ammo: 60 },
            UZI: { id: 'UZI', icon: 'üî´', speed: 35, damage: 80, delay: 50, color: '#22d3ee', ammo: 200, burst: true },
            PLASMA: { id: 'PLASMA', icon: 'üî•', speed: 35, damage: 120, delay: 80, color: '#22d3ee', ammo: 150 },
            ROCKET: { id: 'ROCKET', icon: 'üöÄ', speed: 22, damage: 1500, delay: 1500, color: '#f87171', ammo: 15, explosive: true }
        };

        // --- DEFINICI√ìN DE LOS 10 TIPOS DE ZOMBIES ---
        const ZOMBIE_TYPES = Array.from({ length: 10 }, (_, i) => {
            const index = i + 1;
            return {
                id: index,
                videoSrc: `zombie${index}.mp4`,
                radius: (35 + (i * 12)) * 1.15,
                hp: 150 * Math.pow(1.85, i),
                speed: 3.2 - (i * 0.28),
                damage: 5 + (i * 4),
                scoreValue: 500 * index,
                color: `hsl(${140 - (i * 14)}, 100%, 50%)`
            };
        });

        const ASSETS_URLS = {
            hospital: 'https://cdn-icons-png.flaticon.com/512/2966/2966327.png',
            refuge: 'https://cdn-icons-png.flaticon.com/512/2590/2590525.png',
            gasStation: 'https://cdn-icons-png.flaticon.com/512/1066/1066744.png',
            hero: [
                'https://cdn-icons-png.flaticon.com/512/3408/3408545.png',
                'https://cdn-icons-png.flaticon.com/512/4140/4140037.png',
                'https://cdn-icons-png.flaticon.com/512/1154/1154443.png',
                'https://cdn-icons-png.flaticon.com/512/606/606553.png'
            ],
            bot: 'https://cdn-icons-png.flaticon.com/512/1067/1067357.png',
            tree: 'https://cdn-icons-png.flaticon.com/512/1940/1940922.png'
        };

        // --- VARIABLES GLOBALES DEL JUEGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let images = {};
        let zombieVideos = [];
        let playerVideo, soldierVideo;
        let player, entities = [], bullets = [], buildings = [], splatters = [], items = [], portals = [];
        let walls = [], mazes = [], doors = [], torches = [], trees = [];
        let camera = { x: 0, y: 0, zoom: 0.85 };
        let keys = {}, touchMove = { x: 0, y: 0 }, touchStart = null, pinchDist = null;
        let isGameOver = false, isPaused = false, score = 0, kills = 0, targetKills = 100, currentLvl = 1;
        let activeWKey = 'KNIFE', selectedAvatarIdx = 0, isFiring = false, lastFire = 0;
        let buildMode = false;
        let multiplayerPlayers = [];
        let gameMode = 'single';
        
        // --- NUEVAS VARIABLES PARA ILUMINACI√ìN Y NOCHE ---
        let hasFlashlight = false;
        let isFlashlightOn = false;
        let flashlightRange = 400;
        let gameTime = 0; // En segundos
        let isNight = false;
        let nightTransition = 0; // 0 = d√≠a completo, 1 = noche completa
        let treeFireDuration = 0;
        let lightElements = [];

        // --- FUNCIONES DE GUARDADO EN COOKIES ---
        function saveGameToCookie() {
            const gameData = {
                level: currentLvl,
                score: score,
                kills: kills,
                targetKills: targetKills,
                playerName: document.getElementById('player-name-input').value.trim(),
                avatarIndex: selectedAvatarIdx,
                timestamp: Date.now()
            };
            
            const cookieValue = encodeURIComponent(JSON.stringify(gameData));
            const expiration = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 d√≠as
            
            document.cookie = `zombieSurvivorSave=${cookieValue}; expires=${expiration.toUTCString()}; path=/`;
            console.log("Partida guardada en cookie");
        }

        function loadGameFromCookie() {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'zombieSurvivorSave') {
                    try {
                        const gameData = JSON.parse(decodeURIComponent(value));
                        
                        // Verificar si la partida no es muy vieja (menos de 7 d√≠as)
                        const age = Date.now() - gameData.timestamp;
                        if (age < 7 * 24 * 60 * 60 * 1000) {
                            // Mostrar informaci√≥n de partida guardada
                            document.getElementById('resume-btn').classList.remove('hidden');
                            return gameData;
                        }
                    } catch (e) {
                        console.error("Error cargando partida guardada:", e);
                    }
                }
            }
            document.getElementById('resume-btn').classList.add('hidden');
            return null;
        }

        // --- SISTEMA DE ILUMINACI√ìN ---
        function createLightElement(x, y, radius, color, intensity = 0.7) {
            const light = document.createElement('div');
            light.className = 'torch-light';
            light.style.left = '50%';
            light.style.top = '50%';
            light.style.width = `${radius * 2 * camera.zoom}px`;
            light.style.height = `${radius * 2 * camera.zoom}px`;
            light.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
            light.style.opacity = intensity;
            light.style.transform = `translate(-50%, -50%) translate(${(x - camera.x) * camera.zoom}px, ${(y - camera.y) * camera.zoom}px)`;
            
            document.getElementById('light-container').appendChild(light);
            lightElements.push({ element: light, x, y, radius, color, intensity });
            return light;
        }

        function updateLightElements() {
            // Limpiar luces viejas
            lightElements.forEach(l => l.element.remove());
            lightElements = [];
            
            // Crear luz del jugador si tiene linterna
            if (hasFlashlight && isFlashlightOn && !isNight) {
                createLightElement(
                    player.x + Math.cos(player.angle) * 50,
                    player.y + Math.sin(player.angle) * 50,
                    flashlightRange,
                    'rgba(255, 255, 200, 0.9)',
                    0.8
                );
            }
            
            // Crear luces de antorchas
            torches.forEach(torch => {
                if (torch.active) {
                    const flicker = 0.8 + Math.sin(Date.now() / 200 + torch.x) * 0.2;
                    createLightElement(
                        torch.x,
                        torch.y,
                        torch.radius,
                        'rgba(255, 150, 50, 0.8)',
                        flicker * 0.6
                    );
                }
            });
            
            // Crear luces de √°rboles en fuego
            trees.forEach(tree => {
                if (tree.onFire && tree.fireDuration > 0) {
                    const flicker = 0.7 + Math.sin(Date.now() / 150 + tree.x) * 0.3;
                    createLightElement(
                        tree.x,
                        tree.y,
                        tree.radius * 2,
                        'rgba(255, 100, 0, 0.9)',
                        flicker * 0.8
                    );
                }
            });
            
            // Crear luces de balas explosivas
            bullets.forEach(bullet => {
                if (bullet.explosive) {
                    createLightElement(
                        bullet.x,
                        bullet.y,
                        100,
                        'rgba(255, 100, 0, 0.7)',
                        0.6
                    );
                }
            });
        }

        function updateNightCycle() {
            const DAY_DURATION = 300; // 5 minutos en segundos
            const NIGHT_DURATION = 120; // 2 minutos en segundos
            
            gameTime += 1/60; // Asumiendo 60 FPS
            
            const totalCycle = DAY_DURATION + NIGHT_DURATION;
            const cycleTime = gameTime % totalCycle;
            
            if (cycleTime < DAY_DURATION) {
                // Es de d√≠a
                isNight = false;
                nightTransition = 0;
                document.getElementById('time-of-day').textContent = 'üåÖ D√≠a';
                document.getElementById('night-overlay').style.background = 'rgba(0, 0, 20, 0)';
            } else {
                // Es de noche
                isNight = true;
                const nightProgress = (cycleTime - DAY_DURATION) / NIGHT_DURATION;
                nightTransition = nightProgress;
                
                // Oscurecer progresivamente
                const darkness = 0.8 * nightProgress;
                document.getElementById('night-overlay').style.background = `rgba(0, 0, 20, ${darkness})`;
                document.getElementById('time-of-day').textContent = 'üåô Noche';
                
                // Si es de noche y no tiene linterna, spawnear una
                if (!hasFlashlight && nightProgress > 0.3 && Math.random() < 0.01) {
                    spawnFlashlightItem();
                }
            }
        }

        function spawnFlashlightItem() {
            let a = Math.random()*Math.PI*2, d = 800, rx = player.x+Math.cos(a)*d, ry = player.y+Math.sin(a)*d;
            items.push({ x: rx, y: ry, type: 'flashlight' });
        }

        function toggleFlashlight() {
            if (!hasFlashlight) return;
            
            isFlashlightOn = !isFlashlightOn;
            const btn = document.getElementById('flashlight-btn');
            
            if (isFlashlightOn) {
                btn.style.backgroundColor = '#fbbf24';
                btn.style.borderColor = '#f59e0b';
                btn.style.boxShadow = '0 0 20px rgba(251, 191, 36, 0.5)';
            } else {
                btn.style.backgroundColor = '';
                btn.style.borderColor = '';
                btn.style.boxShadow = '';
            }
            
            updateStatus();
        }

        // --- CLASE ENTITY (ACTUALIZADA) ---
        class Entity {
            constructor(x, y, config) {
                this.id = config.id || Math.random().toString(36).substr(2, 9);
                this.x = x; this.y = y;
                this.type = config.type; 
                this.zombieTypeId = config.zombieTypeId || null;
                this.isPlayer = config.isPlayer || false;
                this.isMultiplayerPlayer = config.isMultiplayerPlayer || false;
                this.isBot = config.isBot || false;
                this.team = config.team || 'zombie';
                
                // Aplicar tama√±o de zombie desde configuraci√≥n
                const baseRadius = config.radius || 25;
                this.radius = config.team === 'zombie' ? baseRadius * gameConfig.zombieSize : baseRadius;
                
                this.maxHp = config.hp || 100;
                this.hp = this.maxHp;
                this.baseSpeed = config.speed || 4;
                this.speed = this.baseSpeed * (config.team === 'zombie' ? gameConfig.zombieSpeed : gameConfig.avatarSpeed);
                this.damage = config.damage || 1;
                this.angle = 0;
                this.color = config.color || '#fff';
                this.invul = 0;
                this.active = true;
                this.lives = config.lives || 3;
                this.lastShot = 0;
                this.hasHelmet = false;
                this.onMotorcycle = false;
                this.fuel = 0;
                this.isInvisible = false;
                this.playerName = config.playerName || 'Player';
                this.avatarIdx = config.avatarIdx || 0;
            }

            update() {
                if (this.invul > 0) this.invul--;
                if (this.isPlayer || this.isMultiplayerPlayer) { 
                    this.checkBuildings(); this.checkItems(); this.checkPortals(); this.autoAim(); 
                    if(this.onMotorcycle) { 
                        this.speed = this.baseSpeed * 3 * gameConfig.motoSpeed;
                        this.fuel -= 0.18; 
                        if(this.fuel <= 0) {
                            this.onMotorcycle = false;
                            this.speed = this.baseSpeed * gameConfig.avatarSpeed;
                        }
                    } else {
                        this.speed = this.baseSpeed * gameConfig.avatarSpeed;
                    }
                    
                    // Actualizar √°ngulo basado en movimiento t√°ctil
                    if (touchMove.x || touchMove.y) {
                        this.angle = Math.atan2(touchMove.y, touchMove.x);
                    }
                }
                if (this.isBot) this.aiBot();
                if (this.team === 'zombie') { 
                    this.speed = this.baseSpeed * gameConfig.zombieSpeed;
                    this.handleSeparation(); this.aiZombie(); 
                }
            }

            checkItems() {
                items.forEach((it, i) => {
                    if (Math.hypot(this.x - it.x, this.y - it.y) < this.radius + 40) {
                        if (it.type === 'helmet' && !this.hasHelmet) {
                            this.hasHelmet = true; this.maxHp *= 1.25; this.hp = this.maxHp;
                        } else if (it.type === 'heart') {
                            this.hp = Math.min(this.maxHp, this.hp + 60);
                        } else if (it.type === 'ammo') {
                            Object.keys(WEAPONS).forEach(k => { if(WEAPONS[k].ammo) WEAPONS[k].ammo += 50; });
                        } else if (it.type === 'motorcycle' && !this.onMotorcycle) {
                            this.onMotorcycle = true; this.fuel = 100;
                        } else if (it.type === 'uzi') {
                            WEAPONS.UZI.ammo += 100;
                        } else if (it.type === 'flashlight' && !hasFlashlight) {
                            hasFlashlight = true;
                            document.getElementById('flashlight-btn').classList.remove('hidden');
                            updateStatus();
                        }
                        items.splice(i, 1);
                        if (this.isPlayer) updateHUD();
                    }
                });
            }

            checkBuildings() {
                let statusHTML = '';
                let inRefuge = false;
                buildings.forEach(b => {
                    let d = Math.hypot(this.x - b.x, this.y - b.y);
                    if (d < b.radius + 50) {
                        if (b.type === 'hospital' && this.hp < this.maxHp) {
                            this.hp += 0.9; statusHTML += '<div class="status-badge healing">Regenerando HP</div>';
                        }
                        if (b.type === 'refuge') {
                            inRefuge = true; this.invul = Math.max(this.invul, 10);
                            statusHTML += '<div class="status-badge invisible-mod">Sigilo Activo</div>';
                        }
                        if (b.type === 'gasStation' && this.onMotorcycle) {
                            this.fuel = Math.min(100, this.fuel + 1.5);
                            statusHTML += '<div class="status-badge protected">Cargando Nafta... ‚õΩ</div>';
                        }
                    }
                });
                this.isInvisible = inRefuge;
                if (this.hasHelmet) statusHTML += '<div class="status-badge soldier-mod">Casco Blindado ü™ñ</div>';
                if (this.onMotorcycle) statusHTML += '<div class="status-badge moto-mod">Moto Lista üèçÔ∏è</div>';
                if (hasFlashlight && isFlashlightOn) statusHTML += '<div class="status-badge flashlight-mod">Linterna üî¶</div>';
                
                if (this.isPlayer) {
                    document.getElementById('status-container').innerHTML = statusHTML;
                }
            }

            autoAim() {
                // Si hay movimiento t√°ctil, usar esa direcci√≥n
                if (touchMove.x || touchMove.y) {
                    this.angle = Math.atan2(touchMove.y, touchMove.x);
                    return;
                }
                
                // Sino, apuntar autom√°ticamente al zombie m√°s cercano
                let target = null, minDist = 1100;
                entities.forEach(e => {
                    if (e.active && e.team === 'zombie') {
                        let d = Math.hypot(e.x - this.x, e.y - this.y);
                        if (d < minDist) { minDist = d; target = e; }
                    }
                });
                if (target) this.angle = Math.atan2(target.y - this.y, target.x - this.x);
            }

            // ... resto de m√©todos de Entity sin cambios ...
        }

        // --- FUNCIONES PARA SALIR AL MEN√ö ---
        function exitToMenu() {
            // Guardar partida antes de salir
            saveGameToCookie();
            
            // Mostrar mensaje de confirmaci√≥n
            if (confirm("¬øSalir al men√∫ principal? La partida se guardar√° autom√°ticamente.")) {
                showMainMenu();
                // Ocultar elementos de juego
                document.getElementById('build-btn').classList.add('hidden');
                document.getElementById('exit-btn').classList.add('hidden');
                document.getElementById('flashlight-btn').classList.add('hidden');
                // Detener bucle de juego
                isGameOver = true;
            }
        }

        // --- FUNCIONES DE CONSTRUCCI√ìN MEJORADAS ---
        function placeTorch() {
            if (!buildMode) return;
            
            const torchX = player.x + Math.cos(player.angle) * 80;
            const torchY = player.y + Math.sin(player.angle) * 80;
            
            torches.push({
                x: torchX,
                y: torchY,
                radius: 200,
                active: true,
                hp: 1000,
                maxHp: 1000,
                placedOnWall: false
            });
        }

        function spawnTree(x, y) {
            trees.push({
                x: x,
                y: y,
                radius: 60 + Math.random() * 40,
                onFire: false,
                fireDuration: 0,
                maxFireDuration: 300 // 5 segundos a 60 FPS
            });
        }

        function checkFireSpreading() {
            // Verificar si antorchas prenden √°rboles cercanos
            torches.forEach(torch => {
                if (torch.active) {
                    trees.forEach(tree => {
                        if (!tree.onFire) {
                            const distance = Math.hypot(torch.x - tree.x, torch.y - tree.y);
                            if (distance < torch.radius + tree.radius) {
                                // Chance de prender fuego
                                if (Math.random() < 0.01) {
                                    tree.onFire = true;
                                    tree.fireDuration = tree.maxFireDuration;
                                }
                            }
                        }
                    });
                }
            });
            
            // Actualizar duraci√≥n del fuego en √°rboles
            trees.forEach(tree => {
                if (tree.onFire && tree.fireDuration > 0) {
                    tree.fireDuration--;
                    if (tree.fireDuration <= 0) {
                        tree.onFire = false;
                    }
                }
            });
        }

        // --- FUNCIONES DE INTERFAZ MEJORADAS ---
        function showConfiguration() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('configuration-screen').style.display = 'flex';
            
            // Cargar valores actuales
            document.getElementById('zombie-speed-slider').value = gameConfig.zombieSpeed * 100;
            document.getElementById('avatar-speed-slider').value = gameConfig.avatarSpeed * 100;
            document.getElementById('moto-speed-slider').value = gameConfig.motoSpeed * 100;
            document.getElementById('bot-count-slider').value = gameConfig.botCount;
            document.getElementById('zombie-size-slider').value = gameConfig.zombieSize * 100;
            document.getElementById('difficulty-select').value = gameConfig.difficulty;
            
            updateSliderValues();
        }

        function updateSliderValues() {
            const zombieVal = document.getElementById('zombie-speed-slider').value;
            const avatarVal = document.getElementById('avatar-speed-slider').value;
            const motoVal = document.getElementById('moto-speed-slider').value;
            const botVal = document.getElementById('bot-count-slider').value;
            const sizeVal = document.getElementById('zombie-size-slider').value;
            
            document.getElementById('zombie-speed-value').textContent = 
                zombieVal == 100 ? 'Normal' : zombieVal < 100 ? 'Lento' : 'R√°pido';
            document.getElementById('avatar-speed-value').textContent = 
                avatarVal == 100 ? 'Normal' : avatarVal < 100 ? 'Lento' : 'R√°pido';
            document.getElementById('moto-speed-value').textContent = 
                motoVal == 100 ? 'Normal' : motoVal < 100 ? 'Lento' : 'R√°pido';
            document.getElementById('bot-count-value').textContent = `${botVal} Bots`;
            document.getElementById('zombie-size-value').textContent = 
                sizeVal == 100 ? 'Normal' : sizeVal < 100 ? 'Peque√±o' : 'Grande';
        }

        function saveConfiguration() {
            gameConfig.zombieSpeed = document.getElementById('zombie-speed-slider').value / 100;
            gameConfig.avatarSpeed = document.getElementById('avatar-speed-slider').value / 100;
            gameConfig.motoSpeed = document.getElementById('moto-speed-slider').value / 100;
            gameConfig.botCount = parseInt(document.getElementById('bot-count-slider').value);
            gameConfig.zombieSize = document.getElementById('zombie-size-slider').value / 100;
            gameConfig.difficulty = document.getElementById('difficulty-select').value;
            
            // Guardar en localStorage
            localStorage.setItem('zombieSurvivorConfig', JSON.stringify(gameConfig));
            
            showMainMenu();
        }

        // --- INICIALIZACI√ìN Y BUCLE PRINCIPAL MEJORADO ---
        window.onload = () => {
            // Cargar configuraci√≥n guardada
            const savedConfig = localStorage.getItem('zombieSurvivorConfig');
            if (savedConfig) {
                Object.assign(gameConfig, JSON.parse(savedConfig));
            }
            
            // Cargar partida guardada
            loadGameFromCookie();
            
            // Cargar im√°genes
            Object.keys(ASSETS_URLS).forEach(k => {
                if (Array.isArray(ASSETS_URLS[k])) {
                    images[k] = ASSETS_URLS[k].map(u => { 
                        let i = new Image(); 
                        i.src = u; 
                        return i; 
                    });
                } else { 
                    images[k] = new Image(); 
                    images[k].src = ASSETS_URLS[k]; 
                }
            });
            
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight;
            
            document.getElementById('main-menu').style.display = 'flex';
            
            // Configurar eventos de los sliders
            document.getElementById('zombie-speed-slider').addEventListener('input', updateSliderValues);
            document.getElementById('avatar-speed-slider').addEventListener('input', updateSliderValues);
            document.getElementById('moto-speed-slider').addEventListener('input', updateSliderValues);
            document.getElementById('bot-count-slider').addEventListener('input', updateSliderValues);
            document.getElementById('zombie-size-slider').addEventListener('input', updateSliderValues);
        };

        // --- FUNCI√ìN START GAME MEJORADA ---
        function startGame(resume, mode) {
            gameMode = mode;
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) return;
            
            document.getElementById('singleplayer-screen').style.display = 'none';
            player = new Entity(0, 0, { 
                type: 'human', 
                isPlayer: true, 
                hp: 250, 
                speed: 8.5, 
                team: 'human', 
                lives: 3,
                playerName: name,
                avatarIdx: selectedAvatarIdx
            });
            
            entities = []; bullets = []; buildings = []; splatters = []; items = []; portals = [];
            walls = []; mazes = []; doors = []; torches = []; trees = [];
            isGameOver = false; isPaused = false; score = 0; kills = 0;
            buildMode = false;
            hasFlashlight = false;
            isFlashlightOn = false;
            gameTime = 0;
            
            // Inicializar munici√≥n UZI
            WEAPONS.UZI.ammo = 200;
            
            if (resume) {
                const savedGame = loadGameFromCookie();
                if (savedGame) {
                    currentLvl = savedGame.level;
                    score = savedGame.score;
                    kills = savedGame.kills;
                    targetKills = savedGame.targetKills;
                } else {
                    currentLvl = 1;
                    targetKills = 100;
                }
            } else { 
                currentLvl = 1; 
                targetKills = 100; 
            }
            
            loadMedia();
            
            // Generar laberintos
            generateMaze();
            
            // Spawnear algunos muros iniciales
            for(let i = 0; i < 10; i++) {
                walls.push({
                    x: (Math.random()-0.5) * 3000,
                    y: (Math.random()-0.5) * 3000,
                    width: 80 + Math.random() * 40,
                    height: 80 + Math.random() * 40,
                    hp: 500,
                    maxHp: 500
                });
            }
            
            // Spawnear √°rboles
            for(let i = 0; i < 20; i++) {
                spawnTree(
                    (Math.random()-0.5) * 4000,
                    (Math.random()-0.5) * 4000
                );
            }
            
            // Spawnear bots seg√∫n configuraci√≥n
            for(let i = 0; i < gameConfig.botCount; i++) {
                entities.push(new Entity(
                    (Math.random()-0.5) * 1000,
                    (Math.random()-0.5) * 1000,
                    { 
                        type: 'human', 
                        isBot: true, 
                        hp: 180, 
                        speed: 6, 
                        team: 'human',
                        color: '#10b981'
                    }
                ));
            }
            
            // Mostrar botones de juego
            document.getElementById('build-btn').classList.remove('hidden');
            document.getElementById('exit-btn').classList.remove('hidden');
            document.getElementById('flashlight-btn').classList.add('hidden');
            
            updateHUD(); 
            requestAnimationFrame(gameLoop);
        }

        // --- BUCLE DE JUEGO MEJORADO ---
        function gameLoop() {
            if (isGameOver) return;
            if (!isPaused) {
                updateLogic();
                updateNightCycle();
                checkFireSpreading();
            }
            draw();
            updateLightElements();
            document.getElementById('map-zombies-count').innerText = entities.filter(e => e.team === 'zombie' && e.active).length;
            requestAnimationFrame(gameLoop);
        }

        // --- DIBUJAR MEJORADO ---
        function draw() {
            // Fondo oscuro (m√°s oscuro si es de noche)
            const baseDarkness = isNight ? 0.9 : 0.95;
            ctx.fillStyle = `rgba(2, 4, 8, ${baseDarkness})`; 
            ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // Grid de fondo (menos visible de noche)
            ctx.strokeStyle = isNight ? 'rgba(255,255,255,0.01)' : 'rgba(255,255,255,0.03)';
            let s = 150 * camera.zoom;
            for(let x=(-camera.x*camera.zoom)%s; x<canvas.width; x+=s){ 
                ctx.beginPath(); 
                ctx.moveTo(x,0); 
                ctx.lineTo(x,canvas.height); 
                ctx.stroke(); 
            }
            for(let y=(-camera.y*camera.zoom)%s; y<canvas.height; y+=s){ 
                ctx.beginPath(); 
                ctx.moveTo(0,y); 
                ctx.lineTo(canvas.width,y); 
                ctx.stroke(); 
            }

            // Dibujar √°rboles
            trees.forEach(tree => {
                const sx = (tree.x - camera.x) * camera.zoom;
                const sy = (tree.y - camera.y) * camera.zoom;
                const size = tree.radius * 2 * camera.zoom;
                
                if (tree.onFire) {
                    // Dibujar fuego
                    ctx.fillStyle = `rgba(255, ${100 + Math.sin(Date.now()/100)*50}, 0, 0.8)`;
                    ctx.beginPath();
                    ctx.arc(sx, sy, size * 0.8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Part√≠culas de fuego
                    for(let i = 0; i < 3; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * size * 0.6;
                        const px = sx + Math.cos(angle) * distance;
                        const py = sy + Math.sin(angle) * distance;
                        const pr = 5 + Math.random() * 10;
                        
                        ctx.fillStyle = `rgba(255, 200, 0, ${0.5 + Math.random() * 0.3})`;
                        ctx.beginPath();
                        ctx.arc(px, py, pr * camera.zoom, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else {
                    // Dibujar √°rbol normal
                    ctx.drawImage(images.tree, sx - size/2, sy - size/2, size, size);
                }
            });

            // ... resto de dibujado sin cambios ...

            // Dibujar antorchas
            torches.forEach(torch => {
                const sx = (torch.x - camera.x) * camera.zoom;
                const sy = (torch.y - camera.y) * camera.zoom;
                const torchSize = 30 * camera.zoom;
                
                // Base de la antorcha
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(sx - torchSize/4, sy - torchSize, torchSize/2, torchSize);
                
                // Fuego
                if (torch.active) {
                    const flicker = Math.sin(Date.now() / 200) * 0.3 + 0.7;
                    ctx.fillStyle = `rgba(255, ${100 + Math.sin(Date.now()/150)*50}, 0, ${flicker})`;
                    ctx.beginPath();
                    ctx.arc(sx, sy - torchSize * 1.2, torchSize * 0.8, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        // --- ACTUALIZAR ESTADO ---
        function updateStatus() {
            let statusHTML = '';
            if (hasFlashlight && isFlashlightOn) statusHTML += '<div class="status-badge flashlight-mod">Linterna üî¶</div>';
            if (player.hasHelmet) statusHTML += '<div class="status-badge soldier-mod">Casco Blindado ü™ñ</div>';
            if (player.onMotorcycle) statusHTML += '<div class="status-badge moto-mod">Moto Lista üèçÔ∏è</div>';
            
            document.getElementById('status-container').innerHTML = statusHTML;
        }

        // --- GUARDAR AUTOM√ÅTICAMENTE PERI√ìDICAMENTE ---
        setInterval(() => {
            if (!isGameOver && !isPaused && gameMode === 'single') {
                saveGameToCookie();
            }
        }, 30000); // Guardar cada 30 segundos

        // ... resto del c√≥digo sin cambios (event listeners, etc.) ...
    </script>
</body>
</html>
